# 📝 杂项指南

(本文档会持续更新)

- 尽量用 genesis.tensor。用 taichi 内核时先用 tensor.assert_contiguous() 检查张量是否连续，因为 taichi 只支持连续外部张量。
- 不要暴露 taichi 相关用法。
- 新增类时记得实现 `__repr__()` 便于调试 (参考 genesis/engine/states.py)。
- 所有模拟相关内容都放在 genesis.engine 里。
- 用 `genesis.logger.info()`/`debug()`/`warning()` 代替 `print()`。
- 提醒用户不要过度查询场景状态。查询的状态会存入场景级列表作为计算图的一部分。用 `scene.reset_grad()` 时会释放列表,释放 GPU 内存。
- 层级结构 - 我们把各层实体创建都做了统一和独立的抽象:
  - 物理求解器：支持 MPM、PBD、SPH、FEM、刚体等。用户可以灵活选择,不用改前端 API。
  - 材料 -> 决定了后端物理求解器。有 MPMLiquid、SPHLiquid、PBDLiquid、MPMElastic、FEMElastic 等。
  - 几何 -> 定义实体形状。可以是形状原语、网格或 URDF。这些几何形状和求解器无关。
  - 所有实体都通过 `scene.add_entity()` 添加。
- 默认求解顺序(保持代码一致):
  - 刚体
  - 角色
  - mpm
  - sph
  - pbd
  - fem
  - sf
- 参数约定:
  - 四元数: `[w, x, y, z]`
  - 欧拉角
    - 用户输入: 外在 x-y-z,单位是 `度`。用了 `scipy.Rotation` 的 `xyz` 顺序。
    - 内部 xyz: 用内在旋转顺序 x-y-z,和 mujoco 一样。角速度用旋转向量。
- 用 `id` 表示对象的 `uuid`, `idx` 表示索引
- `uv` 顺序
  - assimp、trimesh: 从左下角开始
  - 我们的、pygltflib、luisa: 从左上角开始
- 模拟选项和求解器选项
  - 同时存在的参数,求解器选项优先级更高。没定义时用模拟选项的值初始化。
  - 建议用模拟选项定义 dt,让所有求解器用相同时间尺度。但可以给不同求解器设不同 dt。
  - 刚体求解器按步操作,其他按子步操作。非刚体求解器在模拟选项里用 `substeps`。
- 刚体求解器的设计约定
  - 用 `*_idx` 表示属性,如 `link_info.parent_idx`
  - 循环迭代用 `i_*` 表示 id
  - 内核循环变量:
    - 后缀: `i_l`链接, `i_p`父链接, `i_r`根链接, `i_g`几何, `i_d`自由度
    - 前缀: `l_`链接, `l_info`链接信息, `g_`几何, `p_`父级
  - 索引存储:
    - 各类存全局偏移索引。查询实体时全局索引更好
    - 每个对象存:
      - 父类引用
      - 全局 `idx`
      - 子项的偏移
  - root vs base
    - 内部用 `root`,文档用 `base`
  - 控制接口:
    - 根位置合并到第一个固定关节
    - 通过命令速度控制
    - 位置控制用后台 PD 控制器发速度命令
  - mjcf vs urdf
    - mjcf 跳过 worldbody
    - urdf 加载所有内容
  - 碰撞处理用凸化几何:
    - 网格资产生成凸包
    - mjcf 基于 mujoco 几何凸化
    - urdf 凸化最低级网格
- 可视化模式支持:
  - 刚体: visual、collision、sdf,默认 visual
  - 可变形非流体: visual、particle、recon,默认 visual
  - 流体: particle、recon,默认 particle
